from fastapi import FastAPI
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.exporter.zipkin import ZipkinSpanExporter
from opentelemetry.instrumentation.fastapi import FastAPIInstrumentor

app = FastAPI()

# Set up the Tracer Provider
trace.set_tracer_provider(TracerProvider())

# Configure Zipkin exporter
zipkin_exporter = ZipkinSpanExporter(
    service_name="your-fastapi-service",
    endpoint="http://your-zipkin-service:9411/api/v2/spans",
)

# Set up the Batch Span Processor to export traces to Zipkin
trace.get_tracer_provider().add_span_processor(
    BatchSpanProcessor(zipkin_exporter)
)

# Instrument the FastAPI application
FastAPIInstrumentor.instrument_app(app)

# Your existing FastAPI routes
@app.get("/")
async def root():
    return {"message": "Hello World"}
