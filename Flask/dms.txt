import openpyxl
from openpyxl.utils.cell import get_column_letter
from openpyxl.formula import Tokenizer

def extract_formula_details(workbook, sheet_name, column_name):
    # Initialize a dictionary to store formula details
    formula_details = {
        'formula': None,
        'is_formula': False,
        'referenced_columns': [],
    }
    
    # Load the Excel file
    sheet = workbook[sheet_name]
    
    # Get the cell containing the formula
    cell = sheet[column_name + '1']
    
    # Check if the cell has a formula
    if cell.has_formula:
        formula_details['is_formula'] = True
        formula_details['formula'] = cell.formula
        
        # Tokenize the formula to identify cell references
        tokenizer = Tokenizer(formula_details['formula'])
        for token in tokenizer.items:
            if token.type == 'OPERAND' and ':' not in token.string:
                # Extract the referenced column name
                reference = token.string.split('$')[-1]
                formula_details['referenced_columns'].append(reference)
        
        # Recursively extract details for referenced columns
        referenced_formula_chain = {}
        for referenced_column in formula_details['referenced_columns']:
            referenced_details = extract_formula_details(workbook, sheet_name, referenced_column)
            referenced_formula_chain[referenced_column] = referenced_details
        
        formula_details['referenced_formula_chain'] = referenced_formula_chain
    
    return formula_details

# Load the Excel file
excel_file_path = 'your_excel_file.xlsx'
workbook = openpyxl.load_workbook(excel_file_path)

# Specify the sheet name and column name for analysis
sheet_name = 'Sheet1'
column_name = 'A'

# Extract formula details recursively
result = extract_formula_details(workbook, sheet_name, column_name)

# Print the formula details
print(f"Column: {column_name}")
print(f"Formula: {result['formula']}")
print(f"Is Formula: {result['is_formula']}")
print(f"Referenced Columns: {', '.join(result['referenced_columns'])}")
print("Referenced Formula Chain:")
for referenced_column, referenced_details in result['referenced_formula_chain'].items():
    print(f"  {referenced_column}: {referenced_details['formula']}")

# Close the Excel file
workbook.close()
